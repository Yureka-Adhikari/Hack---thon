import { db } from "./firebase-config.js";
import {
  collection,
  addDoc,
  deleteDoc,
  doc,
  query,
  orderBy,
  onSnapshot,
  serverTimestamp,
} from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

document.addEventListener("DOMContentLoaded", () => {
  const container = document.getElementById("broadcastContainer");
  const postBtn = document.getElementById("postBtn");

  if (!container || !postBtn) {
    console.error("Required elements not found in HTML.");
    return;
  }

  // ================= REAL-TIME LISTENER =================
  // This replaces loadBroadcasts(). It stays active and watches for changes.
  const q = query(collection(db, "broadcasts"), orderBy("createdAt", "desc"));

  onSnapshot(q, (snapshot) => {
    container.innerHTML = ""; // Clear for re-render

    if (snapshot.empty) {
      container.innerHTML =
        '<div class="col-12 text-center mt-5"><h5>No active broadcasts.</h5></div>';
      return;
    }

    snapshot.forEach((docSnap) => {
      const post = docSnap.data();
      const docId = docSnap.id;

      // Handle the timestamp safely while it's still being generated by the server
      const dateString = post.createdAt?.toDate
        ? post.createdAt.toDate().toLocaleString()
        : "Syncing...";

      const cardWrapper = document.createElement("div");
      cardWrapper.className = "col-md-4 mb-4";
      cardWrapper.innerHTML = `
        <div class="broadcast-card shadow-sm p-3 ${post.emergency ? "emergency border-danger" : ""}" 
             style="background: white; border-radius: 15px; position: relative; border-left: 5px solid ${post.emergency ? "#dc3545" : "#2A4B79"}">
          
          <button class="btn btn-sm btn-outline-danger delete-btn" 
                  style="position: absolute; top: 10px; right: 10px;">
            <i class="bi bi-trash"></i>
          </button>

          ${post.emergency ? `<span class="badge bg-danger mb-2">Emergency</span>` : ""}

          <h5 class="fw-bold">${post.title}</h5>
          <p class="text-muted small mb-2">${dateString}</p>
          <p class="card-text">${post.content}</p>
        </div>
      `;

      // Event Listener for Delete Button
      cardWrapper
        .querySelector(".delete-btn")
        .addEventListener("click", async () => {
          if (confirm("Delete this broadcast for everyone?")) {
            try {
              await deleteDoc(doc(db, "broadcasts", docId));
              // No need to call loadBroadcasts(), onSnapshot handles it!
            } catch (error) {
              console.error("Error deleting:", error);
            }
          }
        });

      container.appendChild(cardWrapper);
    });
  });

  // ================= CREATE BROADCAST =================
  postBtn.addEventListener("click", async () => {
    const titleField = document.getElementById("title");
    const contentField = document.getElementById("content");
    const emergencyField = document.getElementById("emergency");

    const title = titleField.value.trim();
    const content = contentField.value.trim();
    const emergency = emergencyField.checked;

    if (!title || !content) {
      alert("Please fill all fields");
      return;
    }

    // UI Feedback
    postBtn.disabled = true;
    postBtn.innerHTML =
      '<span class="spinner-border spinner-border-sm"></span> Posting...';

    try {
      await addDoc(collection(db, "broadcasts"), {
        title,
        content,
        emergency,
        createdAt: serverTimestamp(),
      });

      // Clear form
      titleField.value = "";
      contentField.value = "";
      emergencyField.checked = false;

      // Close Bootstrap Modal
      const modalEl = document.getElementById("createModal");
      const modal = bootstrap.Modal.getInstance(modalEl);
      if (modal) modal.hide();
    } catch (error) {
      console.error("Error creating broadcast:", error);
      alert("Failed to post. Check Firestore Rules.");
    } finally {
      postBtn.disabled = false;
      postBtn.innerText = "Post";
    }
  });
});
